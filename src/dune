(library
  (name elpi)
  (public_name elpi)
  (preprocess (per_module
    ((pps ppx_deriving.std) elpi_API elpi_util elpi_ast elpi_data elpi_compiler)
    ((pps ppx_deriving.std trace_ppx --trace_ppx-on) elpi_runtime_trace_on)
    ((pps ppx_deriving.std trace_ppx --trace_ppx-off) elpi_runtime_trace_off)
    ((action (system "camlp5o -I . -I +camlp5 pa_extend.cmo pa_lexer.cmo %{input-file}")) elpi_parser)
    ))
  (libraries re.str camlp5.gramlib unix)
  (flags -linkall)
  (modules elpi elpi_util elpi_parser elpi_ast elpi_compiler elpi_data elpi_ptmap elpi_builtin elpi_API elpi_runtime_trace_on elpi_runtime_trace_off)
  (private_modules elpi_util elpi_parser elpi_ast elpi_compiler elpi_data elpi_ptmap elpi_runtime_trace_on elpi_runtime_trace_off)
)

(rule (copy# elpi_runtime.ml elpi_runtime_trace_on.ml))
(rule (copy# elpi_runtime.ml elpi_runtime_trace_off.ml))
(rule (copy# elpi_runtime.mli elpi_runtime_trace_on.mli))
(rule (copy# elpi_runtime.mli elpi_runtime_trace_off.mli))

(install
  (section lib)
  (files builtin.elpi elpi-checker.elpi elpi_quoted_syntax.elpi elpi2html.elpi)
)

(rule
  (targets builtin.elpi)
  (mode promote)
  (action (with-stdout-to %{targets}
    (progn
      (echo "% File generated by elpi -document-builtins, do not edit")
      (run elpi -document-builtins))))
)
